name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU (optional, multi-arch support)
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx (optional, faster builds)
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

    - name: Build and tag image
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        # choose tag strategy: run_number + short sha
        SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-8)
        VERSION_TAG="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
        IMAGE="${DOCKER_USERNAME}/ecom-app"
        docker build -t ${IMAGE}:latest -t ${IMAGE}:${VERSION_TAG} .
        echo "IMAGE=${IMAGE}" >> $GITHUB_ENV
        echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV

    - name: Push image tags to Docker Hub
      run: |
        docker push ${IMAGE}:latest
        docker push ${IMAGE}:${VERSION_TAG}

    - name: Verify pushed image
      run: |
        echo "Pushed images:"
        echo "${IMAGE}:latest"
        echo "${IMAGE}:${VERSION_TAG}"
